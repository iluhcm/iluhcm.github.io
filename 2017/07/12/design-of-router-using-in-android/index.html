<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="2yx0JNDw3DWn3FVwl0XV9ba4wAjjbvZ3viXpvjGwBa8">













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Android,Router,Priority,Regular Expression,Annotation,Annotation Processor,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1">






<meta name="description" content="前言当前，Android路由框架已经有很多了，如雨后春笋般出现，大概是因为去年提出了Android组件化的概念。当一个产品的业务规模上升到一定程度，或者是跨团队开发时，团队/模块间的合作问题就会暴露出来。如何保持团队间业务的往来？如何互不影响或干涉对方的开发进度？如何调用业务方的功能？组件化给上述问题提供了一个答案。组件化所要解决的核心问题是解耦，路由正是为了解决模块间的解耦而出现的。本文阐述了考">
<meta name="keywords" content="Android,Router,Priority,Regular Expression,Annotation,Annotation Processor">
<meta property="og:type" content="article">
<meta property="og:title" content="考拉Android客户端路由总线设计">
<meta property="og:url" content="https://iluhcm.com/2017/07/12/design-of-router-using-in-android/index.html">
<meta property="og:site_name" content="Xing&#39;s Blog">
<meta property="og:description" content="前言当前，Android路由框架已经有很多了，如雨后春笋般出现，大概是因为去年提出了Android组件化的概念。当一个产品的业务规模上升到一定程度，或者是跨团队开发时，团队/模块间的合作问题就会暴露出来。如何保持团队间业务的往来？如何互不影响或干涉对方的开发进度？如何调用业务方的功能？组件化给上述问题提供了一个答案。组件化所要解决的核心问题是解耦，路由正是为了解决模块间的解耦而出现的。本文阐述了考">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://nos.netease.com/knowledge/0d94b9af-bb78-4a7c-9322-e23bcfec551c?imageView&thumbnail=980x0">
<meta property="og:image" content="http://nos.netease.com/knowledge/130829f3-7355-44ee-af48-b2a7e8ffbbae?imageView&thumbnail=980x0">
<meta property="og:updated_time" content="2018-11-01T06:14:06.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="考拉Android客户端路由总线设计">
<meta name="twitter:description" content="前言当前，Android路由框架已经有很多了，如雨后春笋般出现，大概是因为去年提出了Android组件化的概念。当一个产品的业务规模上升到一定程度，或者是跨团队开发时，团队/模块间的合作问题就会暴露出来。如何保持团队间业务的往来？如何互不影响或干涉对方的开发进度？如何调用业务方的功能？组件化给上述问题提供了一个答案。组件化所要解决的核心问题是解耦，路由正是为了解决模块间的解耦而出现的。本文阐述了考">
<meta name="twitter:image" content="http://nos.netease.com/knowledge/0d94b9af-bb78-4a7c-9322-e23bcfec551c?imageView&thumbnail=980x0">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://iluhcm.com/2017/07/12/design-of-router-using-in-android/">





  <title>考拉Android客户端路由总线设计 | Xing's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?03e8bdd436b4561c8e760c9459ee8003";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xing's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">To be a better man.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://iluhcm.com/2017/07/12/design-of-router-using-in-android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xing Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xing's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">考拉Android客户端路由总线设计</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-12T09:42:59+08:00">
                2017-07-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/12/design-of-router-using-in-android/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/07/12/design-of-router-using-in-android/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当前，Android路由框架已经有很多了，如雨后春笋般出现，大概是因为去年提出了Android组件化的概念。当一个产品的业务规模上升到一定程度，或者是跨团队开发时，团队/模块间的合作问题就会暴露出来。如何保持团队间业务的往来？如何互不影响或干涉对方的开发进度？如何调用业务方的功能？组件化给上述问题提供了一个答案。组件化所要解决的核心问题是解耦，路由正是为了解决模块间的解耦而出现的。本文阐述了考拉Android端的路由设计方案，尽管与市面上的方案大同小异，但更多的倾向于与考拉业务进行一定程度的结合。</p>
<h2 id="传统的页面跳转"><a href="#传统的页面跳转" class="headerlink" title="传统的页面跳转"></a>传统的页面跳转</h2><p>页面跳转主要分为三种，App页面间跳转、H5跳转回App页面以及App跳转至H5。</p>
<h3 id="App页面间跳转"><a href="#App页面间跳转" class="headerlink" title="App页面间跳转"></a>App页面间跳转</h3><p>App页面间的跳转，对于新手来说一般会在跳转的页面使用如下代码：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>(this, MainActivity.<span class="keyword">class</span>);</span><br><span class="line"><span class="keyword">intent</span>.putExtra(<span class="string">"dataKey"</span>, <span class="string">"dataValue"</span>);</span><br><span class="line">startActivity(<span class="keyword">intent</span>);</span><br></pre></td></tr></table></figure>
<p>对于有一定经验的程序员，会在跳转的类生成自己的跳转方法：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OrderManagerActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">	public static void launch(<span class="type">Context</span> context, int startTab) &#123;</span><br><span class="line">		<span class="type">Intent</span> i = <span class="keyword">new</span> <span class="type">Intent</span>(context, <span class="type">OrderManagerActivity</span>.<span class="keyword">class</span>);</span><br><span class="line">		i.putExtra(<span class="type">INTENT_IN_INT_START_TAB</span>, startTab);</span><br><span class="line">		context.startActivity(i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无论使用哪种方式，本质都是生成一个<code>Intent</code>，然后再通过<code>Context.startActivity(Intent)/Activity.startActivityForResult(Intent, int)</code>实现页面跳转。这种方式的不足之处是当包含多个模块，但模块间没有相互依赖时，这时候的跳转会变得相当困难。如果已知其他模块的类名以及对应的路径，可以通过<code>Intent.setComponent(Component)</code>方法启动其他模块的页面，但往往模块的类名是有可能变化的，一旦业务方把模块换个名字，这种隐藏的Bug对于开发的内心来说是崩溃的。另一方面，这种重复的模板代码，每次至少写两行才能实现页面跳转，代码存在冗余。</p>
<h3 id="H5-App页面跳转"><a href="#H5-App页面跳转" class="headerlink" title="H5-App页面跳转"></a>H5-App页面跳转</h3><p>对于考拉这种电商应用，活动页面具有时效性和即时性，这两种特性在任何时候都需要得到保障。运营随时有可能更改活动页面，也有可能要求点击某个链接就能跳转到一个App页面。传统的做法是对<code>WebViewClient.shouldOverrideUrlLoading(WebView, String)</code>进行拦截，判断url是否有对应的App页面可以跳转，然后取出url中的params封装成一个<code>Intent</code>传递并启动App页面。</p>
<p>感受一下在考拉App工程中曾经出现过的下面这段代码：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static Intent startActivityByUrl(Context context, <span class="built_in">String</span> url, <span class="built_in">boolean</span> fromWeb, <span class="built_in">boolean</span> outer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(url) &amp;&amp; url.startsWith(StringConstants.REDIRECT_URL)) &#123;  </span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="built_in">String</span> realUrl = Uri.parse(url).getQueryParameter(<span class="string">"target"</span>);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(realUrl)) &#123;</span><br><span class="line">                url = URLDecoder.decode(realUrl, <span class="string">"UTF-8"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Intent intent = <span class="built_in">null</span>;</span><br><span class="line">    try &#123;</span><br><span class="line">        Uri uri = Uri.parse(url);</span><br><span class="line">        <span class="built_in">String</span> host = uri.getHost();</span><br><span class="line">        <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; pathSegments = uri.getPathSegments();</span><br><span class="line">        <span class="built_in">String</span> path = uri.getPath();</span><br><span class="line">        int segmentsLength = (pathSegments == <span class="built_in">null</span> ? <span class="number">0</span> : pathSegments.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!host.contains(StringConstants.KAO_LA)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((StringUtils.isBlank(path)))&#123;</span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            <span class="keyword">return</span> intent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (segmentsLength == <span class="number">2</span> &amp;&amp; path.startsWith(StringConstants.JUMP_TO_GOODS_DETAIL)) &#123;</span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_SPRING_ACTIVITY_TAB)) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_SPRING_ACTIVITY_DETAIL) &amp;&amp; segmentsLength == <span class="number">3</span>) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.START_CART) &amp;&amp; segmentsLength == <span class="number">1</span>) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_COUPON_DETAIL)</span><br><span class="line">                || (path.startsWith(StringConstants.JUMP_TO_COUPON) &amp;&amp; segmentsLength == <span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (canOpenMainPage(host, uri.getPath())) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.START_ORDER)) &#123; </span><br><span class="line">            <span class="keyword">if</span> (!UserInfo.isLogin(context)) &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.START_SAVE)) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_NEW_DISCOVERY)) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_NEW_DISCOVERY_2) &amp;&amp; segmentsLength == <span class="number">3</span>) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.START_BRAND_INTRODUCE)</span><br><span class="line">                || path.startsWith(StringConstants.START_BRAND_INTRODUCE2)) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.START_BRAND_DETAIL) &amp;&amp; segmentsLength == <span class="number">2</span>) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_ORDER_DETAIL)) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (!UserInfo.isLogin(context) &amp;&amp; outer) &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"/cps/user/certify.html"</span>)) &#123;   </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.IDENTIFY)) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"/album/share.html"</span>)) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"/album/tag/share.html"</span>)) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"/live/roomDetail.html"</span>)) &#123;   </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_ORDER_COMMENT)) &#123; </span><br><span class="line">            <span class="keyword">if</span> (!UserInfo.isLogin(context) &amp;&amp; outer) &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (openOrderDetail(url, path)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!UserInfo.isLogin(context) &amp;&amp; outer) &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(StringConstants.JUMP_TO_SINGLE_COMMENT)) &#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"/member/activity/vip_help.html"</span>)) &#123;</span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"/goods/search.html"</span>)) &#123;</span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(path.startsWith(<span class="string">"/afterSale/progress.html"</span>))&#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(path.startsWith(<span class="string">"/afterSale/apply.html"</span>))&#123;  </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(path.startsWith(<span class="string">"/order/track.html"</span>)) &#123; </span><br><span class="line">            <span class="keyword">do</span> something<span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="built_in">null</span> &amp;&amp; !(context instanceof Activity)) &#123;</span><br><span class="line">        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码整整260行，看到代码时我的内心是崩溃的。这种做法的弊端在于：</p>
<ul>
<li><strong>判断不合理</strong>。上述代码仅判断了HOST是否包含<code>StringConstants.KAO_LA</code>，然后根据PATH区分跳转到哪个页面，PATH也只判断了起始部分，当URL越来越多的时候很有可能造成误判。</li>
<li><strong>耦合性太强</strong>。已知拦截的所有页面的引用都必须能够拿到，否则无法跳转；</li>
<li><strong>代码混乱</strong>。PATH非常多，从众多的PATH中匹配多个已知的App页面，想必要判断匹配规则就要写很多函数解决；</li>
<li><strong>拦截过程不透明</strong>。开发者很难在URL拦截的过程中加入自己的业务逻辑，如打点、启动Activity前添加特定的Flag等；</li>
<li><strong>没有优先级概念，也无法降级处理</strong>。同一个URL，只要第一个匹配到App页面，就只能打开这个页面，无法通过调整优先级跳转到别的页面或者使用H5打开。</li>
</ul>
<h3 id="App页面-H5跳转"><a href="#App页面-H5跳转" class="headerlink" title="App页面-H5跳转"></a>App页面-H5跳转</h3><p>这种情况不必多说，启动一个WebViewActivity即可。</p>
<h2 id="页面路由的意义"><a href="#页面路由的意义" class="headerlink" title="页面路由的意义"></a>页面路由的意义</h2><p>路由最先被应用于网络中，路由的定义是通过互联的网络把信息从<strong>源地址</strong>传输到<strong>目的地址</strong>的活动。页面跳转也是相当于从<strong>源页面</strong>跳转到<strong>目标页面</strong>的过程，每个页面可以定义为一个统一资源标识符（URI），在网络当中能够被别人访问，也可以访问已经被定义了的页面。路由常见的使用场景有以下几种：</p>
<ul>
<li>App接收到一个通知，点击通知打开App的某个页面（OuterStartActivity）</li>
<li>浏览器App中点击某个链接打开App的某个页面（OuterStartActivity）</li>
<li>App的H5活动页面打开一个链接，可能是H5跳转，也可能是跳转到某一个native页面（WebViewActivity）</li>
<li>打开页面需要某些条件，先验证完条件，再去打开那个页面（需要登录）</li>
<li>App内的跳转，可以减少手动构建Intent的成本，同时可以统一携带部分参数到下一个页面（打点）</li>
</ul>
<p>除此之外，使用路由可以避免上述弊端，能够降低开发者页面跳转的成本。</p>
<h1 id="考拉路由总线"><a href="#考拉路由总线" class="headerlink" title="考拉路由总线"></a>考拉路由总线</h1><h2 id="路由框架"><a href="#路由框架" class="headerlink" title="路由框架"></a>路由框架</h2><p> <img src="http://nos.netease.com/knowledge/0d94b9af-bb78-4a7c-9322-e23bcfec551c?imageView&amp;thumbnail=980x0" alt="Alt pic"> </p>
<p><a href="http://nos.netease.com/knowledge/0d94b9af-bb78-4a7c-9322-e23bcfec551c" target="_blank" rel="noopener">点击查看大图</a></p>
<p>考拉路由框架主要分为三个模块：<strong>路由收集</strong>、<strong>路由初始化</strong>以及<strong>页面路由</strong>。路由收集阶段，定义了基于Activity类的注解，通过<code>Android Processing Tool</code>(以下简称“APT”)收集路由信息并生成路由表类；路由初始化阶段，根据生成的路由表信息注入路由字典；页面路由阶段，则通过路由字典查找路由信息，并根据查找结果定制不同的路由策略略。</p>
<h2 id="路由设计思路"><a href="#路由设计思路" class="headerlink" title="路由设计思路"></a>路由设计思路</h2><p>总的来说，考拉路由设计追求的是功能模块的解耦，能够实现基本路由功能，以及开发者使用上足够简单。考拉路由的前两个阶段对于路由使用者几乎是无成本的，只需要在使用路由的页面定义一个类注解<code>@Router</code>即可，页面路由的使用也相当简单，后面会详细介绍。</p>
<h3 id="功能设计"><a href="#功能设计" class="headerlink" title="功能设计"></a>功能设计</h3><p>路由在一定程度上和网络请求是类似的，可以分为请求、处理以及响应三个阶段。这三个阶段对使用者来说既可以是透明的，也可以在路由过程中进行拦截处理。考拉路由框架目前支持的功能有：</p>
<ol>
<li>支持基本Activity的启动，以及startActivityForResult回调；✅</li>
<li>支持不同协议执行不同跳转；（kaola://*、http(s)://*、native://*等）✅</li>
<li>支持多个SCHEME/HOST/PATH跳转至同一个页面；（(pre.)*.kaola.com(.hk)）✅</li>
<li>支持路由的正则匹配；✅</li>
<li>支持Activity启动使用不同的Flag；✅</li>
<li>支持路由的优先级配置；✅</li>
<li>支持对路由的动态拦截、监听以及降级；✅</li>
</ol>
<p>以上功能保证了考拉业务模块间的解耦，也能够满足目前产品和运营的需求。</p>
<h3 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h3><p> <img src="http://nos.netease.com/knowledge/130829f3-7355-44ee-af48-b2a7e8ffbbae?imageView&amp;thumbnail=980x0" alt="Alt pic"> </p>
<p><a href="http://nos.netease.com/knowledge/130829f3-7355-44ee-af48-b2a7e8ffbbae" target="_blank" rel="noopener">点击查看大图</a></p>
<p>一个好的模块或框架，需要事先设计好接口，预留足够的权限供调用者支配，才能满足各种各样的需求。考拉路由框架在设计过程中使用了常见的设计模式，如Builder模式、Factory模式、Wrapper模式等，并遵循了一些设计原则。（最近在看第二遍Effective Java，对以下原则深有体会，推荐看一下）</p>
<ul>
<li><strong>针对接口编程，而不是针对实现编程</strong></li>
</ul>
<p>这条规则排在最前面的原因是，针对接口编程，不管是对开发者还是对使用者，真的是<strong>百利而无一害</strong>。在路由版本迭代的过程中，底层对接口无论实现怎样的修改，也不会影响到上层调用。对于业务来说，路由的使用是无感知的。</p>
<p>考拉路由框架在设计过程中并未完全遵循这条原则，下一个版本的迭代会尽量按照这条原则来实现。但在路由过程中的关键步骤都预留了接口，具体有：</p>
<p><strong>RouterRequestCallback</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>RouterRequestCallback &#123;</span><br><span class="line">    void onFound(RouterRequest request, RouterResponse response);</span><br><span class="line"></span><br><span class="line">    boolean onLost(RouterRequest request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由表中是否能够匹配到路由信息的回调，如果能够匹配，则回调<code>onFound()</code>，如果不能够匹配，则返回<code>onLost()</code>。<code>onLost()</code>的结果由开发来定义，如果返回的结果是<code>true</code>，则认为开发者处理了这次路由不匹配的结果，最终返回<code>RouterResult</code>的结果是成功路由。</p>
<p><strong>RouterHandler</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>RouterHandler extends RouterStarter &#123;</span><br><span class="line">	RouterResponse findResponse(RouterRequest request); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由处理与启动接口，根据给定的路由请求，查找路由信息，根据路由响应结果，分发给相应的启动器执行后续页面跳转。这个接口的设计不太合理，功能上不完善，后续会重新设计这个接口，让调用方有权限干预查找路由的过程。</p>
<p><strong>RouterResultCallback</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public interface RouterResultCallback &#123;</span><br><span class="line">    <span class="keyword">boolean </span><span class="keyword">beforeRoute(Context </span><span class="built_in">context</span>, Intent intent)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    void doRoute(<span class="built_in">Context</span> <span class="built_in">context</span>, Intent intent, Object <span class="keyword">extra);</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   void errorRoute(<span class="built_in">Context</span> <span class="built_in">context</span>, Intent intent, String errorCode, Object <span class="keyword">extra);</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure>
<p>匹配到路由信息后，真正执行路由过程的回调。<code>beforeRoute()</code>这个方法是在真正路由之前的回调，如果开发者返回<code>true</code>，则认为这条路由信息已被调用者拦截，不会再回调后面的<code>doRoute()</code>以及执行路由。在路由过程中发生的任何异常，都会回调<code>errorRoute()</code>方法，这时候路由中断。</p>
<p><strong>ResponseInvoker</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>ResponseInvoker &#123;</span><br><span class="line">    void invoke(Context context, Intent intent, Object<span class="built_in">..</span>. args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由执行者。如果开发需要执行路由前进行一些全局操作，例如添加额外的信息传入到下一个Activity，则可以自己实现这个接口。路由框架提供默认的实现：<code>ActivityInvoker</code>。开发也可以继承<code>ActivityInvoker</code>，重写<code>invoke()</code>方法，先实现自己的业务逻辑，再调用<code>super.invoke()</code>方法。</p>
<p><strong>OnActivityResultListener</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>OnActivityResultListener &#123;</span><br><span class="line">    void onActivityResult(int requestCode, int resultCode, Intent data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>特别强调一下这个Listener。本来这个回调的作用是方便调用者在执行<code>startActivityForResult</code>的时候可以通过回调来告知结果，但由于<strong>不保留活动</strong>的限制，离开页面以后这个监听器是无法被系统保存(<code>saveInstanceState</code>)的，因此不推荐在<code>Activity/Fragment</code>中使用回调，而是在非Activity组件/模块里使用，如<code>View/Window/Dialog</code>。这个过程已经由<code>core</code>包里的<code>CoreBaseActivity</code>实现，开发使用的时候，可以直接调用<code>CoreBaseActivity.startActivityForResult(intent, requestCode, onActivityResultListener)</code>，也可以通过<code>KaolaRouter.with(context).url(url).startForResult(requestCode, onActivityResultListener)</code>调用。例如，要启动订单管理页并回调：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">KaolaRouter.with(context)</span><br><span class="line">        .url(url)</span><br><span class="line">        .data(<span class="string">"orderId"</span>, <span class="string">"replace url param key."</span>)</span><br><span class="line">        .startForResult(<span class="number">1</span>, <span class="keyword">new</span> OnActivityResultListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">                DebugLog.e(requestCode + <span class="string">" "</span> + resultCode + <span class="string">" "</span> + data.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>RouterResult</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>RouterResult &#123;</span><br><span class="line"></span><br><span class="line">    boolean isSuccess();</span><br><span class="line"></span><br><span class="line">    RouterRequest getRouterRequest();</span><br><span class="line"></span><br><span class="line">    RouterResponse getRouterResponse();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>告知路由的结果，路由结果可以被干预，例如<code>RouterRequestCallback.onLost()</code>，返回<code>true</code>的时候，路由也是成功的。这个接口不管路由的成功或失败都会返回。</p>
<p><strong>不随意暴露不必要的API</strong></p>
<p><em>“要区别设计良好的模块与设计不好的模块，最重要的因素在于，这个模块对于外部的其他模块而⾔言，是否隐藏其内部数据和其他实现细节。设计良好的模块会隐藏所有的实现细节，把它的API与它的实现清晰地隔离开来。然后，模块之间只通过它们的API进行通信，一个模块不需要知道其他模块的内部工作情况。这被称为封装(encapsulation)。”</em>（摘自Effective Java, P58）</p>
<p>举个例子，考拉路由框架对路由调用的入参做了限制，一旦入参，则不能再做修改，调用者无需知道路由框架对使用这些参数怎么实现调用者想要的功能。实现上，由<code>RouterRequestWrapper</code>继承自<code>RouterRequestBuilder</code>，后者通过Builder模式给用户构造相关的参数，前者通过Wrapper模式装饰<code>RouterRequestBuilder</code>中的所有变量，并在<code>RouterRequestWrapper</code>类中提供所有参数的get函数，供路由框架使用。</p>
<p><strong>单一职责</strong></p>
<p>无论是类还是方法，均需要遵循单一职责原则。一个类实现一个功能，一个方法做一件事。例如，<code>KaolaRouterHandler</code>是考拉路由的处理器，实现了<code>RouterHandler</code>接口，实现路由的查找与转发；<code>RouterRequestBuilder</code>用于收集路由请求所需参数；<code>RouterResponseFactory</code>用于生成路由响应的结果。</p>
<p><strong>提供默认实现</strong></p>
<p>针对接口编程的好处是随时可以替换实现，考拉路由框架在路由过程中的所有监听、拦截以及路由过程都提供了默认的实现。使用者即可以不关心底层的实现逻辑，也可以根据需要替换相关的实现。</p>
<h2 id="考拉路由实现原理"><a href="#考拉路由实现原理" class="headerlink" title="考拉路由实现原理"></a>考拉路由实现原理</h2><p>考拉路由框架基于注解收集路由信息，通过APT实现路由表的动态生成，类似于ButterKnife的做法，在运行时导入路由表信息，并通过正则表达式查找路由，根据路由结果实现最终的页面跳转。</p>
<h3 id="收集路由信息"><a href="#收集路由信息" class="headerlink" title="收集路由信息"></a>收集路由信息</h3><p>首先定义一个注解<code>@Router</code>，注解里包含了路由协议、路由主机、路由路径以及路由优先级。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE) </span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS) </span><br><span class="line">public <span class="meta">@interface</span> Router &#123;</span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     * URI协议，已经提供默认值，默认实现了四种协议：https、http、kaola、native</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    <span class="built_in">String</span> scheme() <span class="keyword">default</span> <span class="string">"(https|http|kaola|native)://"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     * URI主机，已经提供默认值</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    <span class="built_in">String</span> host() <span class="keyword">default</span> <span class="string">"(pre\\.)?(\\w+\\.)?kaola\\.com(\\.hk)?"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     * URI路径，选填，如果使用默认值，则只支持本地路由，不支持url拦截</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    <span class="built_in">String</span> value() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     * 路由优先级，默认为0。</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    <span class="built_in">int</span> priority() <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于需要使用路由的页面，只需要在类的声明处加上这个注解，标明这个页面对应的路由路径即可。例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Router</span>(<span class="string">"/app/myQuestion.html"</span>) </span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyQuestionAndAnswerActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123; </span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么通过APT生成的标记这个页面的url则是一个正则表达式：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(https|http|kaola|native)://(pre<span class="symbol">\.</span>)?(<span class="symbol">\w</span>+<span class="symbol">\.</span>)?kaola<span class="symbol">\.</span>com(<span class="symbol">\.</span>hk)?/app/myQuestion<span class="symbol">\.</span>html</span><br></pre></td></tr></table></figure>
<p>路由表则是由多条这样的正则表达式构成。</p>
<h3 id="生成路由表"><a href="#生成路由表" class="headerlink" title="生成路由表"></a>生成路由表</h3><p>路由表的生成需要使用APT工具以及<em>Square</em>公司开源的<a href="https://github.com/square/javapoet" target="_blank" rel="noopener">javapoet</a>类库，目的是根据我们定义的<code>Router</code>注解让机器帮我们“写代码”，生成一个Map类型的路由表，其中key根据<code>Router</code>注解的信息生成对应的正则表达式，value是这个注解对应的类的信息集合。首先定义一个<code>RouterProcessor</code>，继承自<code>AbstractProcessor</code>，</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RouterProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public synchronized void init(<span class="type">ProcessingEnvironment</span> processingEnv) &#123;</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnv);</span><br><span class="line">		<span class="comment">// 初始化相关环境信息</span></span><br><span class="line">        mFiler = processingEnv.getFiler();</span><br><span class="line">        elementUtil = processingEnv.getElementUtils();</span><br><span class="line">        typeUtil = processingEnv.getTypeUtils();</span><br><span class="line">        <span class="type">Log</span>.setLogger(processingEnv.getMessager());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">Set</span>&lt;<span class="type">String</span>&gt; getSupportedAnnotationTypes() &#123;</span><br><span class="line">        <span class="type">Set</span>&lt;<span class="type">String</span>&gt; supportAnnotationTypes = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 获取需要处理的注解类型，目前只处理Router注解</span></span><br><span class="line">        supportAnnotationTypes.add(<span class="type">Router</span>.<span class="keyword">class</span>.getCanonicalName());</span><br><span class="line">        <span class="keyword">return</span> supportAnnotationTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public boolean process(<span class="type">Set</span>&lt;? <span class="keyword">extends</span> <span class="type">TypeElement</span>&gt; annotations, <span class="type">RoundEnvironment</span> roundEnv) &#123;</span><br><span class="line">        <span class="comment">// 收集与Router相关的所有类信息，解析并生成路由表</span></span><br><span class="line">        <span class="type">Set</span>&lt;? <span class="keyword">extends</span> <span class="type">Element</span>&gt; routeElements = roundEnv.getElementsAnnotatedWith(<span class="type">Router</span>.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> parseRoutes(routeElements);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">            <span class="type">Log</span>.e(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述的三个方法属于AbstractProcessor的方法，<code>public abstract boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</code>是抽象方法，需要子类实现。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> boolean parseRoutes(Set&lt;? extends Element&gt; routeElements) throws IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == routeElements || routeElements.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取Activity类的类型，后面用于判断是否是其子类</span></span><br><span class="line">    TypeElement typeActivity = elementUtil.getTypeElement(ACTIVITY);</span><br><span class="line">	<span class="comment">// 获取路由Builder类的标准类名</span></span><br><span class="line">    ClassName routeBuilderCn = ClassName.<span class="keyword">get</span>(RouteBuilder.<span class="keyword">class</span>);</span><br><span class="line">	<span class="comment">// 构建Map&lt;String, Route&gt;集合</span></span><br><span class="line">    String routerConstClassName = RouterProvider.ROUTER_CONST_NAME;</span><br><span class="line">    TypeSpec.Builder typeSpec = TypeSpec.classBuilder(routerConstClassName).addJavadoc(WARNING_TIPS).addModifiers(PUBLIC);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Map&lt;String, Route&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ParameterizedTypeName inputMapTypeName =</span><br><span class="line">            ParameterizedTypeName.<span class="keyword">get</span>(ClassName.<span class="keyword">get</span>(Map.<span class="keyword">class</span>), ClassName.<span class="keyword">get</span>(String.<span class="keyword">class</span>),</span><br><span class="line">                    ClassName.<span class="keyword">get</span>(Route.<span class="keyword">class</span>));</span><br><span class="line">    ParameterSpec groupParamSpec = ParameterSpec.builder(inputMapTypeName, ROUTER_MAP_NAME).build();</span><br><span class="line">    MethodSpec.Builder loadIntoMethodOfGroupBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</span><br><span class="line">            .addAnnotation(Override.<span class="keyword">class</span>)</span><br><span class="line">            .addModifiers(PUBLIC)</span><br><span class="line">            .addParameter(groupParamSpec);</span><br><span class="line">	<span class="comment">// 将路由信息放入Map&lt;String, Route&gt;集合中</span></span><br><span class="line">    <span class="keyword">for</span> (Element element : routeElements) &#123;</span><br><span class="line">        TypeMirror tm = element.asType();</span><br><span class="line">        Router route = element.getAnnotation(Router.<span class="keyword">class</span>);</span><br><span class="line">		<span class="comment">// 获取当前Activity的标准类名</span></span><br><span class="line">        <span class="keyword">if</span> (typeUtil.isSubtype(tm, typeActivity.asType())) &#123;</span><br><span class="line">            ClassName activityCn = ClassName.<span class="keyword">get</span>((TypeElement) element);</span><br><span class="line">            String key = <span class="string">"key"</span> + element.getSimpleName().toString();</span><br><span class="line">            String routeString = RouteBuilder.assembleRouteUri(route.scheme(), route.host(), route.value());</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == routeString) &#123;</span><br><span class="line">                <span class="comment">//String keyValue = RouteBuilder.generateUriFromClazz(Activity.class);</span></span><br><span class="line">                loadIntoMethodOfGroupBuilder.addStatement(<span class="string">"String <span class="variable">$N</span>= <span class="variable">$T</span>.generateUriFromClazz(<span class="variable">$T</span>.class)"</span>, key,</span><br><span class="line">                        routeBuilderCn, activityCn);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//String keyValue = "(" + route.value() + ")|(" + RouteBuilder.generateUriFromClazz(Activity.class) + ")";</span></span><br><span class="line">                loadIntoMethodOfGroupBuilder.addStatement(</span><br><span class="line">                        <span class="string">"String <span class="variable">$N</span>=<span class="variable">$S</span> + <span class="variable">$S</span> + <span class="variable">$S</span>+<span class="variable">$T</span>.generateUriFromClazz(<span class="variable">$T</span>.class)+<span class="variable">$S</span>"</span>, key, <span class="string">"("</span>, routeString, <span class="string">")|("</span>,</span><br><span class="line">                        routeBuilderCn, activityCn, <span class="string">")"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * routerMap.put(url, RouteBuilder.build(String url, int priority, Class&lt;?&gt; destination));</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            loadIntoMethodOfGroupBuilder.addStatement(<span class="string">"<span class="variable">$N</span>.put(<span class="variable">$N</span>, <span class="variable">$T</span>.build(<span class="variable">$N</span>, <span class="variable">$N</span>, <span class="variable">$T</span>.class))"</span>, ROUTER_MAP_NAME,</span><br><span class="line">                    key, routeBuilderCn, key, String.valueOf(route.priority()), activityCn);</span><br><span class="line"></span><br><span class="line">            typeSpec.addField(generateRouteConsts(element));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate RouterConst.java</span></span><br><span class="line">    JavaFile.builder(RouterProvider.OUTPUT_DIRECTORY, typeSpec.build()).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate RouterGenerator</span></span><br><span class="line">    JavaFile.builder(RouterProvider.OUTPUT_DIRECTORY, TypeSpec.classBuilder(RouterProvider.ROUTER_GENERATOR_NAME)</span><br><span class="line">            .addJavadoc(WARNING_TIPS)</span><br><span class="line">            .addSuperinterface(ClassName.<span class="keyword">get</span>(RouterProvider.<span class="keyword">class</span>))</span><br><span class="line">            .addModifiers(PUBLIC)</span><br><span class="line">            .addMethod(loadIntoMethodOfGroupBuilder.build())</span><br><span class="line">            .build()).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终生成的路由表如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY KAOLA PROCESSOR. */</span></span><br><span class="line">public class RouterGenerator implements RouterProvider &#123;</span><br><span class="line">  @Override</span><br><span class="line">  public void loadRouter(Map&lt;String, Route&gt; routerMap) &#123;</span><br><span class="line">    String keyActivityDetailActivity=<span class="string">"("</span> + <span class="string">"(https|http|kaola|native)://(pre<span class="subst">\\</span>.)?(<span class="subst">\\</span>w+<span class="subst">\\</span>.)?kaola<span class="subst">\\</span>.com(<span class="subst">\\</span>.hk)?/activity/spring/<span class="subst">\\</span>w+"</span> + <span class="string">")|("</span>+RouteBuilder.generateUriFromClazz(ActivityDetailActivity.class)+<span class="string">")"</span>;</span><br><span class="line">    routerMap.put(keyActivityDetailActivity, RouteBuilder.build(keyActivityDetailActivity, <span class="number">0</span>, ActivityDetailActivity.class));</span><br><span class="line">    String keyLabelDetailActivity=<span class="string">"("</span> + <span class="string">"(https|http|kaola|native)://(pre<span class="subst">\\</span>.)?(<span class="subst">\\</span>w+<span class="subst">\\</span>.)?kaola<span class="subst">\\</span>.com(<span class="subst">\\</span>.hk)?/album/tag/share<span class="subst">\\</span>.html"</span> + <span class="string">")|("</span>+RouteBuilder.generateUriFromClazz(LabelDetailActivity.class)+<span class="string">")"</span>;</span><br><span class="line">    routerMap.put(keyLabelDetailActivity, RouteBuilder.build(keyLabelDetailActivity, <span class="number">0</span>, LabelDetailActivity.class));</span><br><span class="line">    String keyMyQuestionAndAnswerActivity=<span class="string">"("</span> + <span class="string">"(https|http|kaola|native)://(pre<span class="subst">\\</span>.)?(<span class="subst">\\</span>w+<span class="subst">\\</span>.)?kaola<span class="subst">\\</span>.com(<span class="subst">\\</span>.hk)?/app/myQuestion.html"</span> + <span class="string">")|("</span>+RouteBuilder.generateUriFromClazz(MyQuestionAndAnswerActivity.class)+<span class="string">")"</span>;</span><br><span class="line">    routerMap.put(keyMyQuestionAndAnswerActivity, RouteBuilder.build(keyMyQuestionAndAnswerActivity, <span class="number">0</span>, MyQuestionAndAnswerActivity.class));</span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>RouteBuilder.generateUriFromClazz(Class)</code>的实现如下，目的是生成一条默认的与标准类名相关的native跳转规则。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> SCHEME_NATIVE = <span class="string">"native://"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> generateUriFromClazz(Class&lt;?&gt; destination) &#123;</span><br><span class="line">    <span class="keyword">String</span> rawUri = SCHEME_NATIVE + destination.getCanonicalName();</span><br><span class="line">    <span class="keyword">return</span> rawUri.replaceAll(<span class="string">"\\."</span>, <span class="string">"\\\\."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，路由集合的key是一条正则表达式，包括了url拦截规则以及自定义的包含标准类名的native跳转规则。例如，<code>keyMyQuestionAndAnswerActivity</code>最终生成的key是</p>
<pre><code>((https|http|kaola|native)://(pre\\.)?(\\w+\\.)?kaola\\.com(\\.hk)?/app/
myQuestion.html)|(native://com.kaola.modules.answer.myAnswer.
MyQuestionAndAnswerActivity)
</code></pre><p>这样，调用者不仅可以通过默认的拦截规则<br><code>(https|http|kaola|native)://(pre\\.)?(\\w+\\.)?kaola\\.com(\\.hk)?/app/myQuestion.html)</code><br>跳转到对应的页面，也可以通过<br><code>(native://com.kaola.modules.answer.myAnswer.MyQuestionAndAnswerActivity)</code>。<br>这样的好处是模块间的跳转也可以使用，不需要依赖引用类。而native跳转会专门生成一个类<code>RouterConst</code>来记录，如下：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY KAOLA PROCESSOR. */</span><br><span class="line">public class RouterConst &#123;</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_ActivityDetailActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.activity</span><span class="variable">.ActivityDetailActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_LabelDetailActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.albums</span><span class="variable">.label</span><span class="variable">.LabelDetailActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_MyQuestionAndAnswerActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.answer</span><span class="variable">.myAnswer</span><span class="variable">.MyQuestionAndAnswerActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_CertificatedNameActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.auth</span><span class="variable">.activity</span><span class="variable">.CertificatedNameActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_CPSCertificationActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.auth</span><span class="variable">.activity</span><span class="variable">.CPSCertificationActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_BrandDetailActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.brands</span><span class="variable">.branddetail</span><span class="variable">.ui</span><span class="variable">.BrandDetailActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_CartContainerActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.cart</span><span class="variable">.CartContainerActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_SingleCommentShowActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.comment</span><span class="variable">.detail</span><span class="variable">.SingleCommentShowActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_CouponGoodsActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.coupon</span><span class="variable">.activity</span><span class="variable">.CouponGoodsActivity</span>";</span><br><span class="line">  <span class="attribute">public static final String ROUTE_TO_CustomerAssistantActivity = "native</span>://com<span class="variable">.kaola</span><span class="variable">.modules</span><span class="variable">.customer</span><span class="variable">.CustomerAssistantActivity</span>";</span><br><span class="line">  ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化路由"><a href="#初始化路由" class="headerlink" title="初始化路由"></a>初始化路由</h3><p>路由初始化在Application的过程中以同步的方式进行。通过获取<code>RouterGenerator</code>的类直接生成实例，并将路由信息保存在<code>sRouterMap</code>变量中。</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static void init() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        sRouterMap = <span class="function"><span class="keyword">new</span> <span class="title">HashMap</span>&lt;&gt;();</span></span><br><span class="line"><span class="function">        ((<span class="type">RouterProvider</span>) (<span class="type">Class</span>.forName(<span class="type">ROUTER_CLASS_NAME</span>).<span class="title">getConstructor</span>().<span class="title">newInstance</span>())).<span class="title">loadRouter</span>(sRouterMap);</span></span><br><span class="line"><span class="function">    &#125; <span class="title">catch</span> (<span class="type">Exception</span> e) &#123;</span></span><br><span class="line"><span class="function">        <span class="title">e</span>.<span class="title">printStackTrace</span>();</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="页面路由"><a href="#页面路由" class="headerlink" title="页面路由"></a>页面路由</h3><p>给定一个url以及上下文环境，即可使用路由。调用方式如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">KaolaRouter</span><span class="selector-class">.with</span>(<span class="selector-tag">context</span>)<span class="selector-class">.url</span>(<span class="selector-tag">url</span>)<span class="selector-class">.start</span>();</span><br></pre></td></tr></table></figure>
<p>页面路由分为路由请求生成，路由查找以及路由结果执行这几个步骤。路由请求目前较为简单，仅是封装了一个RouterRequest接口</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>RouterRequest &#123;</span><br><span class="line">	Uri getUriRequest(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由的查找过程相对复杂，除了遍历路由初始化以后导入内存的路由表，还需要判断各种各样的前置条件。具体的条件判断代码中有相关注释。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RouterResponse findResponse(RouterRequest request) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == sRouterMap) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//throw new IllegalStateException(</span></span><br><span class="line">        <span class="comment">//        String.format("Router has not been initialized, please call %s.init() first.",</span></span><br><span class="line">        <span class="comment">//                KaolaRouter.class.getSimpleName()));</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mRouterRequestWrapper.getDestinationClass() != <span class="literal">null</span>) &#123;</span><br><span class="line">        RouterResponse response = RouterResponseFactory.buildRouterResponse(<span class="literal">null</span>, mRouterRequestWrapper);</span><br><span class="line">        reportFoundRequestCallback(request, response);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    Uri uri = request.getUriRequest();</span><br><span class="line">    String requestUrl = uri.toString();</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(requestUrl)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Route&gt; entry : sRouterMap.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (RouterUtils.matchUrl(requestUrl, entry.getKey())) &#123;</span><br><span class="line">                Route routerModel = entry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != routerModel) &#123;</span><br><span class="line">                    RouterResponse response =</span><br><span class="line">                            RouterResponseFactory.buildRouterResponse(routerModel, mRouterRequestWrapper);</span><br><span class="line">                    reportFoundRequestCallback(request, response);</span><br><span class="line">                    <span class="keyword">return</span> response;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RouterResult start() &#123;</span><br><span class="line">	<span class="comment">// 判断Context引用是否还存在</span></span><br><span class="line">    WeakReference&lt;Context&gt; objectWeakReference = mContextWeakReference;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == objectWeakReference) &#123;</span><br><span class="line">        reportRouterResultError(<span class="literal">null</span>, <span class="literal">null</span>, RouterError.ROUTER_CONTEXT_REFERENCE_NULL, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Context context = objectWeakReference.<span class="keyword">get</span>();</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">        reportRouterResultError(<span class="literal">null</span>, <span class="literal">null</span>, RouterError.ROUTER_CONTEXT_NULL, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 判断路由请求是否有效</span></span><br><span class="line">    <span class="keyword">if</span> (!checkRequest(context)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 遍历查找路路由结果</span></span><br><span class="line">    RouterResponse response = findResponse(mRouterRequestWrapper);</span><br><span class="line">	<span class="comment">// 判断路由结果，执行路由结果为空时的拦截</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == response) &#123;</span><br><span class="line">        boolean handledByCallback = reportLostRequestCallback(mRouterRequestWrapper);</span><br><span class="line">        <span class="keyword">if</span> (!handledByCallback) &#123;</span><br><span class="line">            reportRouterResultError(context, <span class="literal">null</span>, RouterError.ROUTER_RESPONSE_NULL,</span><br><span class="line">                    mRouterRequestWrapper.getRouterRequest());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(handledByCallback, mRouterRequestWrapper, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 获取路由结果执行的接口</span></span><br><span class="line">    ResponseInvoker responseInvoker = getResponseInvoker(context, response);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseInvoker == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Intent intent;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent = RouterUtils.generateResponseIntent(context, response, mRouterRequestWrapper);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        reportRouterResultError(context, <span class="literal">null</span>, RouterError.ROUTER_GENERATE_INTENT_ERROR, e);</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, response);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 生成相应的Intent</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == intent) &#123;</span><br><span class="line">        reportRouterResultError(context, <span class="literal">null</span>, RouterError.ROUTER_GENERATE_INTENT_NULL, response);</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, response);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 获取路由结果回调接口，如果为空，则使用默认提供的实现</span></span><br><span class="line">    RouterResultCallback routerResultCallback = getRouterResultCallback();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由使用者处理</span></span><br><span class="line">    <span class="keyword">if</span> (routerResultCallback.beforeRoute(context, intent)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">true</span>, mRouterRequestWrapper, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        responseInvoker.invoke(context, intent, mRouterRequestWrapper.getRequestCode(),</span><br><span class="line">                mRouterRequestWrapper.getOnActivityResultListener());</span><br><span class="line">        routerResultCallback.doRoute(context, intent, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">true</span>, mRouterRequestWrapper, response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        reportRouterResultError(context, intent, RouterError.ROUTER_INVOKER_ERROR, e);</span><br><span class="line">        <span class="keyword">return</span> getRouterResult(<span class="literal">false</span>, mRouterRequestWrapper, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终会调用<code>ResponseInvoker.invoke()</code>方法执行路由。</p>
<h1 id="待开发"><a href="#待开发" class="headerlink" title="待开发"></a>待开发</h1><ol>
<li>职责链模式，参考OkHttp</li>
<li>集成Fragment</li>
<li>支持异步</li>
<li>路由缓存</li>
<li>路由智能优先级（调用过的，放最前面）</li>
<li>集成权限管理</li>
<li>考虑需要登录的情况，统一处理</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>考拉路由框架与其他路由框架相比，目前功能较简单，目的也仅是支持页面跳转。为了达到对开发者友好、使用简单的目的，本文在设计路由框架的过程中使用了一些简单的设计模式，使得整个系统的可扩展性较强，也能够充分的满足考拉的业务需求。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://github.com/alibaba/ARouter" target="_blank" rel="noopener">https://github.com/alibaba/ARouter</a></li>
<li><a href="http://www.jianshu.com/p/79e9a54e85b2" target="_blank" rel="noopener">http://www.jianshu.com/p/79e9a54e85b2</a></li>
<li><a href="https://joyrun.github.io/2016/08/01/ActivityRouter/" target="_blank" rel="noopener">https://joyrun.github.io/2016/08/01/ActivityRouter/</a></li>
<li><a href="http://www.jianshu.com/p/8a3eeeaf01e8" target="_blank" rel="noopener">http://www.jianshu.com/p/8a3eeeaf01e8</a></li>
<li><a href="http://www.jianshu.com/p/f582c3893bed" target="_blank" rel="noopener">http://www.jianshu.com/p/f582c3893bed</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>Post author:</strong>
      Xing Li
    </li>
    <li class="post-copyright-link">
      <strong>Post link:</strong>
      <a href="https://iluhcm.com/2017/07/12/design-of-router-using-in-android/" title="考拉Android客户端路由总线设计">https://iluhcm.com/2017/07/12/design-of-router-using-in-android/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright Notice: </strong>
      All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/Router/" rel="tag"># Router</a>
          
            <a href="/tags/Priority/" rel="tag"># Priority</a>
          
            <a href="/tags/Regular-Expression/" rel="tag"># Regular Expression</a>
          
            <a href="/tags/Annotation/" rel="tag"># Annotation</a>
          
            <a href="/tags/Annotation-Processor/" rel="tag"># Annotation Processor</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/12/experience-of-adapting-to-android-notifications/" rel="next" title="Android通知栏介绍与适配总结">
                <i class="fa fa-chevron-left"></i> Android通知栏介绍与适配总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/10/design-an-elegant-and-powerful-android-webview-part-one/" rel="prev" title="如何设计一个优雅健壮的Android WebView？（上）">
                如何设计一个优雅健壮的Android WebView？（上） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div id="sidebar-dimmer"></div>
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="Xing Li">
          <p class="site-author-name" itemprop="name">Xing Li</p>
           
              <p class="site-description motion-element" itemprop="description">If asked how the pond can be so lucid and fresh, told that sources with flowing water replenish.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">71</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/iluhcm" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/xing.li.731135" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/iluhcm" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://plus.google.com/101164893136136383839/posts" target="_blank" title="Google+">
                  
                    <i class="fa fa-fw fa-google-plus"></i>
                  
                  Google+
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/lshcm" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/iluhcm" target="_blank" title="Zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Zhihu
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://music.163.com/#/user/home?id=38148117" target="_blank" title="Netease">
                  
                    <i class="fa fa-fw fa-music"></i>
                  
                  Netease
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#传统的页面跳转"><span class="nav-number">1.1.</span> <span class="nav-text">传统的页面跳转</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#App页面间跳转"><span class="nav-number">1.1.1.</span> <span class="nav-text">App页面间跳转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#H5-App页面跳转"><span class="nav-number">1.1.2.</span> <span class="nav-text">H5-App页面跳转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#App页面-H5跳转"><span class="nav-number">1.1.3.</span> <span class="nav-text">App页面-H5跳转</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面路由的意义"><span class="nav-number">1.2.</span> <span class="nav-text">页面路由的意义</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#考拉路由总线"><span class="nav-number">2.</span> <span class="nav-text">考拉路由总线</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#路由框架"><span class="nav-number">2.1.</span> <span class="nav-text">路由框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由设计思路"><span class="nav-number">2.2.</span> <span class="nav-text">路由设计思路</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#功能设计"><span class="nav-number">2.2.1.</span> <span class="nav-text">功能设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#接口设计"><span class="nav-number">2.2.2.</span> <span class="nav-text">接口设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#考拉路由实现原理"><span class="nav-number">2.3.</span> <span class="nav-text">考拉路由实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#收集路由信息"><span class="nav-number">2.3.1.</span> <span class="nav-text">收集路由信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成路由表"><span class="nav-number">2.3.2.</span> <span class="nav-text">生成路由表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化路由"><span class="nav-number">2.3.3.</span> <span class="nav-text">初始化路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面路由"><span class="nav-number">2.3.4.</span> <span class="nav-text">页面路由</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#待开发"><span class="nav-number">3.</span> <span class="nav-text">待开发</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xing Li</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://iluhcm-com.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://iluhcm.com/2017/07/12/design-of-router-using-in-android/';
          this.page.identifier = '2017/07/12/design-of-router-using-in-android/';
          this.page.title = '考拉Android客户端路由总线设计';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://iluhcm-com.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  








  





  

  

  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script>


  

</body>
</html>
